\hypertarget{buffer_test_8bcl-example}{\section{buffer\+\_\+test.\+bcl}
}
A fielded buffers, that contain attribute-\/value pairs called fields.

The attribute is the field’s identifier, and the associated value represents the field’s data content. Fielded buffers provide an excellent structure for communicating parameterized data between cooperating processes, by providing named access to a set of related fields. Programs that need to communicate with other processes can use the F\+M\+L software to provide access to fields without concerning themselves with the structures containing them.

\begin{DoxyAuthor}{Author}
herbert koelman(\href{mailto:herbert.koelman@me.com}{\tt herbert.\+koelman@me.\+com})
\end{DoxyAuthor}

\begin{DoxyCodeInclude}
1 /* $Id$
2 
3    Sample Tuxedo client using ATMI++ libray.
4 
5  */
6 #include <stdlib.h>
7 #include <unistd.h>
8 #include <string.h>
9 #include <string>
10 #include <iostream>
11 #include <fstream>
12 #include <typeinfo>
13 #include "atmi/atmi++.hpp"
14 
15 #include "sample\_fml\_table.h"
16 
17 class buffer\_test : public atmi::abstract\_client \{
18   public:
19     buffer\_test (): atmi::abstract\_client ("btest")\{
20     \};
21 
22     int run ( int argc, char **argv )\{
23       try \{
24 
25         atmi::buffer b (100), a;
26         /*
27            const char *types[5] = \{ typeid(short).name(), typeid(int).name() \};
28            std::cout << "Stored: " << types[0] << std::endl;
29            std::cout << "Stored: " << types[1] << " is a " << std::endl;
30            if(strcmp ( typeid(int).name(), types[1]) == 0 )\{
31            std::cout << "same type int." << std::endl;
32            \}
33            std::cout << "Type id " << typeid(long).name() << std::endl;
34          */
35 
36         std::cout << "atmi::buffer b: " << b.used() << "/" << b.unused() <<", size: " << b.size() << ",
       chksum: " << b.chksum() <<  std::endl;
37 
38         atmi::Tfield<atmi::carray>   unknown\_field;
39         unknown\_field.set\_id(SRVCDAY);
40         unknown\_field.set\_char\_array("salut les amis\(\backslash\)0rray", 19);
41 
42         atmi::Tfield<string> prenom ( EMPNAME );
43         atmi::Tfield<long>   empid ( EMPID );
44         atmi::Tfield<long>   empzip ( EMPZIP );
45         atmi::Tfield<string> nom ( EMPNAME );
46         atmi::Tfield<char *> carray ( SRVCDAY );
47         atmi::Tfield<char *> copy ( SRVCDAY );
48 
49         prenom = "herbert";
50         nom = "this is a char *";
51         empid = 2;
52         carray.set\_char\_array("hello world\(\backslash\)0rray", 16);
53 
54         std::cout << "--------------------------------------" << std::endl << std::endl ;
55         std::cout << "Direct carray buffer access" << std::endl ;
56         // const char *direct\_access = carray ;
57         // auto direct\_access\_length = carray.length();
58 
59         for ( auto x = 0; x < carray.length() ; x++ )\{
60           // printf("%c - %c\(\backslash\)n", direct\_access[x], carray[x]);
61           printf("%c\(\backslash\)n", carray[x]);
62         \}
63         printf("\(\backslash\)n");
64         carray[1] = 'X' ;
65         printf("changed character 1 to X -> %c\(\backslash\)n", carray[1]);
66 
67         std::cout << "--------------------------------------" << std::endl << std::endl ;
68         std::cout << "copy carrays" << std::endl;
69         copy = carray;
70 
71         std::cout << "--------------------------------------" << std::endl << std::endl ;
72         std::cout << "Adding fields into FML buffer: " << std::endl;
73         b.add(unknown\_field);
74         b.add ( empid );
75         b.add ( nom );
76         b.add ( prenom );
77         b.set ( carray );
78         b.print ();
79         std::cout << "--------------------------------------" << std::endl << std::endl ;
80 
81         std::cout << "get SRVCDAY value from FML buffer" << std::endl;
82         b.get ( copy );
83         std::cout << "there should be enough memory no re-allocation expected" << std::endl;
84         b.get ( copy );
85 
86         std::cout << "--------------------------------------" << std::endl << std::endl ;
87 
88         copy.set\_char\_array("0123456789", 10);
89         std::cout << "buffer carray contains " << copy.length() << " characters" << std::endl ;
90         //b.remove(copy);
91         b.set(copy);
92         b.print();
93 
94         atmi::Tfield<char *> resize\_control ( SRVCDAY );
95         std::cout << "resize control initial carray length is  " << resize\_control.length() << std::endl;
96         resize\_control.set\_char\_array("012345678901245678900123456789", 30);
97         b.get(resize\_control);
98 
99         std::cout << "de-allocate ressources" << std::endl ;
100         resize\_control.free\_ressources();
101         std::cout << "  firt call to get from buffer, size before call " << resize\_control.length() <<
       std::endl ;
102         b.get(resize\_control);
103         std::cout << "  second call to get from buffer, size before second call " <<
       resize\_control.length() << std::endl ;
104         b.get(resize\_control);
105         std::cout << "size is " << resize\_control.length() << ", backend store size is " <<
       resize\_control.buffer\_size() << std::endl ;
106 
107         std::cout << "--------------------------------------" << std::endl << std::endl ;
108         std::cout << copy.what() << std::endl;
109         long len = 5;                  //copy.length();
110         char *cav = new char[len];
111         copy.get\_char\_array ( cav, len );
112         for ( int x = 0; x < len; x++ ) \{
113           std::cout << "'"<< cav[x]<<"',";
114         \}
115         std::cout << std::endl;
116 
117         std::cout << "Setting (update) empid value: " << std::endl;
118         empid = 22;
119         b.set ( empid );
120         b.print ();
121 
122         std::cout << "size : " << b.size();
123         b.pack ();
124         std::cout << ", after pack: " << b.size() << std::endl;
125 
126         std::cout << "atmi::buffer (in the end): " << b.used() << "/" << b.unused() <<", size: " <<
       b.size() << ", chksum: " << b.chksum() <<  std::endl;
127 
128         std::cout << "wrapping atmi::buffer." << std::endl ;
129         atmi::buffer wrapper ( b.get\_buffer());
130         nom = "this was added into a wrapper instance of atmi::buffer.";
131         wrapper.set (nom );
132         wrapper.print ();
133 
134         std::cout << "transforming a atmi::buffer into a wrapped buffer." << std::endl;
135         atmi::buffer wrapper1;
136         wrapper1.set\_buffer ( wrapper.get\_buffer());
137         prenom = "this was set by a wrapper";
138         wrapper1.set ( prenom );
139         wrapper1.print();
140 
141       \}catch ( atmi::buffer\_exception &err ) \{
142         cerr << err.what() << ". Ferror : " << err.error() <<std::endl;
143       \} catch ( atmi::atmi\_exception &err ) \{
144         cerr << err.what() << std::endl;
145       \} catch ( std::exception &err ) \{
146         cerr << err.what() << std::endl;
147       \}
148 
149       return 9999;
150     \}
151 
152 \};
153 
154 // program main -------------------------------------------------
155 
156 int main ( int argc, char **argv ) \{
157 
158   try \{
159 
160     std::cout << "atmi::buffer sample program (" << atmi::cpp\_atmi\_version() <<")." << std::endl;
161     buffer\_test btest;
162 
163     std::cout << ", starting up" ;
164     btest.run ( argc, argv );
165 
166   \} catch ( atmi::atmi\_exception &err)\{
167     cerr << std::endl << err.what() << std::endl;
168   \} catch ( std::exception &err ) \{
169     cerr << std::endl << err.what() << std::endl;
170   \}
171   std::cout << ", done." << std::endl;
172 
173   return 0;
174 \}
\end{DoxyCodeInclude}
 