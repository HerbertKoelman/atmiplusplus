\hypertarget{buffer_test_8bcl-example}{\section{buffer\+\_\+test.\+bcl}
}
A fielded buffers, that contain attribute-\/value pairs called fields.

The attribute is the field’s identifier, and the associated value represents the field’s data content. Fielded buffers provide an excellent structure for communicating parameterized data between cooperating processes, by providing named access to a set of related fields. Programs that need to communicate with other processes can use the F\+M\+L software to provide access to fields withou concerning themselves with the structures containing them.

\begin{DoxyAuthor}{Author}
herbert koelman(\href{mailto:herbert.koelman@me.com}{\tt herbert.\+koelman@me.\+com})
\end{DoxyAuthor}

\begin{DoxyCodeInclude}
1 /* $Id$
2 
3    Sample Tuxedo client using ATMI++ libray.
4 
5  */
6 #include <stdlib.h>
7 #include <unistd.h>
8 #include <string.h>
9 #include <string>
10 #include <iostream>
11 #include <fstream>
12 #include <typeinfo>
13 #include "atmi/atmi++.hpp"
14 
15 #include "sample\_fml\_table.h"
16 
17 template< class T, FLDID32 F = 0 >
18 class \_field: public atmi::Tfield<T> \{
19   public:
20     \_field(): atmi::Tfield<T>(F)\{
21     \}
22 
23     \_field( FLDID32 id ): atmi::Tfield<T>(id)\{
24     \}
25 
26     T operator=( T v )\{
27       atmi::Tfield<T>::value = v;
28 
29       return atmi::Tfield<T>::value ;
30     \}
31 \};
32 
33 typedef \_field<std::string,EMPNAME> prenom\_t;
34 typedef \_field<long,EMPID>   empid\_t;
35 typedef \_field<std::string>  void\_t;
36 
37 class fields \{
38   public:
39     fields()\{
40       prenom = "hello world" ;
41       std::cout << \_\_FUNCTION\_\_ << ": " << prenom << std::endl ;
42     \}
43 
44   private:
45     prenom\_t prenom ;
46 \};
47 
48 
49 class field\_empid: public atmi::Tfield<long> \{
50   public:
51     field\_empid(): atmi::Tfield<long>(EMPID)\{
52     \}
53 
54 \};
55 
56 class buffer\_test : public atmi::abstract\_client \{
57   public:
58     buffer\_test (): atmi::abstract\_client ("btest")\{
59     \};
60 
61     int run ( int argc, char **argv )\{
62       try \{
63 
64         atmi::buffer b (100), a;
65         /*
66            const char *types[5] = \{ typeid(short).name(), typeid(int).name() \};
67            std::cout << "Stored: " << types[0] << std::endl;
68            std::cout << "Stored: " << types[1] << " is a " << std::endl;
69            if(strcmp ( typeid(int).name(), types[1]) == 0 )\{
70            std::cout << "same type int." << std::endl;
71            \}
72            std::cout << "Type id " << typeid(long).name() << std::endl;
73          */
74 
75         std::cout << "atmi::buffer b: " << b.used() << "/" << b.unused() <<", size: " << b.size() << ",
       chksum: " << b.chksum() <<  std::endl;
76 
77         atmi::Tfield<atmi::carray>   unknown\_field;
78         unknown\_field.set\_id(SRVCDAY);
79         unknown\_field.set\_char\_array("salut les amis\(\backslash\)0rray", 19);
80 
81         atmi::Tfield<std::string> prenom ( EMPNAME );
82         atmi::Tfield<long>   empid ( EMPID );
83         atmi::Tfield<long>   empzip ( EMPZIP );
84         atmi::Tfield<std::string> nom ( EMPNAME );
85         atmi::Tfield<char *> carray ( SRVCDAY );
86         atmi::Tfield<char *> copy ( SRVCDAY );
87 
88         prenom = "herbert";
89         nom = "this is a char *";
90         empid = 2;
91         carray.set\_char\_array("hello world\(\backslash\)0rray", 16);
92 
93         std::cout << "--------------------------------------" << std::endl << std::endl ;
94         std::cout << "Direct carray buffer access" << std::endl ;
95         // const char *direct\_access = carray ;
96         // auto direct\_access\_length = carray.length();
97 
98         for ( auto x = 0; x < carray.length() ; x++ )\{
99           // printf("%c - %c\(\backslash\)n", direct\_access[x], carray[x]);
100           printf("%c\(\backslash\)n", carray[x]);
101         \}
102         printf("\(\backslash\)n");
103         carray[1] = 'X' ;
104         printf("changed character 1 to X -> %c\(\backslash\)n", carray[1]);
105 
106         std::cout << "--------------------------------------" << std::endl << std::endl ;
107         std::cout << "copy carrays" << std::endl;
108         copy = carray;
109 
110         std::cout << "--------------------------------------" << std::endl << std::endl ;
111         std::cout << "Adding fields into FML buffer: " << std::endl;
112         b.add(unknown\_field);
113         b.add ( empid );
114         b.add ( nom );
115         b.add ( prenom );
116         b.set ( carray );
117         b.print ();
118         std::cout << "--------------------------------------" << std::endl << std::endl ;
119 
120         std::cout << "get SRVCDAY value from FML buffer" << std::endl;
121         b.get ( copy );
122         std::cout << "there should be enough memory no re-allocation expected" << std::endl;
123         b.get ( copy );
124 
125         std::cout << "--------------------------------------" << std::endl << std::endl ;
126 
127         copy.set\_char\_array("0123456789", 10);
128         std::cout << "buffer carray contains " << copy.length() << " characters" << std::endl ;
129         //b.remove(copy);
130         b.set(copy);
131         b.print();
132 
133         atmi::Tfield<char *> resize\_control ( SRVCDAY );
134         std::cout << "resize control initial carray length is  " << resize\_control.length() << std::endl;
135         resize\_control.set\_char\_array("012345678901245678900123456789", 30);
136         b.get(resize\_control);
137 
138         std::cout << "de-allocate ressources" << std::endl ;
139         resize\_control.free\_ressources();
140         std::cout << "  firt call to get from buffer, size before call " << resize\_control.length() <<
       std::endl ;
141         b.get(resize\_control);
142         std::cout << "  second call to get from buffer, size before second call " <<
       resize\_control.length() << std::endl ;
143         b.get(resize\_control);
144         std::cout << "size is " << resize\_control.length() << ", backend store size is " <<
       resize\_control.buffer\_size() << std::endl ;
145 
146         std::cout << "--------------------------------------" << std::endl << std::endl ;
147         std::cout << copy.what() << std::endl;
148         long len = 5;                  //copy.length();
149         char *cav = new char[len];
150         copy.get\_char\_array ( cav, len );
151         for ( int x = 0; x < len; x++ ) \{
152           std::cout << "'"<< cav[x]<<"',";
153         \}
154         std::cout << std::endl;
155 
156         std::cout << "Setting (update) empid value: " << std::endl;
157         empid = 22;
158         b.set ( empid );
159         b.print ();
160 
161         std::cout << "size : " << b.size();
162         b.pack ();
163         std::cout << ", after pack: " << b.size() << std::endl;
164 
165         std::cout << "atmi::buffer (in the end): " << b.used() << "/" << b.unused() <<", size: " <<
       b.size() << ", chksum: " << b.chksum() <<  std::endl;
166 
167         std::cout << "wrapping atmi::buffer." << std::endl ;
168         atmi::buffer wrapper ( b.get\_buffer());
169         nom = "this was added into a wrapper instance of atmi::buffer.";
170         wrapper.set (nom );
171         wrapper.print ();
172 
173         std::cout << "transforming a atmi::buffer into a wrapped buffer." << std::endl;
174         atmi::buffer wrapper1;
175         wrapper1.set\_buffer ( wrapper.get\_buffer());
176         prenom = "this was set by a wrapper";
177         wrapper1.set ( prenom );
178         wrapper1.print();
179 
180       \}catch ( atmi::buffer\_exception &err ) \{
181         std::cerr << err.what() << ". Ferror : " << err.error() <<std::endl;
182       \} catch ( atmi::atmi\_exception &err ) \{
183         std::cerr << err.what() << std::endl;
184       \} catch ( std::exception &err ) \{
185         std::cerr << err.what() << std::endl;
186       \}
187 
188       return 9999;
189     \}
190 
191 \};
192 
193 // program main -------------------------------------------------
194 
195 int main ( int argc, char **argv ) \{
196 
197   try \{
198 
199     std::cout << "atmi::buffer sample program (" << atmi::cpp\_atmi\_version() <<")." << std::endl;
200     buffer\_test btest;
201 
202     fields f;
203     \_field<std::string> v(EMPNAME);
204 
205     prenom\_t prenom ;
206     prenom = "hello prenom\_t" ;
207     std::cout << prenom.what() <<" " << prenom << "." << std::endl;
208     atmi::buffer buffer;
209     buffer.set(prenom);
210     buffer.print();
211 
212     std::cout << ", starting up" ;
213     btest.run ( argc, argv );
214 
215   \} catch ( atmi::atmi\_exception &err)\{
216     std::cerr << std::endl << err.what() << std::endl;
217   \} catch ( std::exception &err ) \{
218     std::cerr << std::endl << err.what() << std::endl;
219   \}
220   std::cout << ", done." << std::endl;
221 
222   return 0;
223 \}
\end{DoxyCodeInclude}
 